<!DOCTYPE html>
<html>
<head>
  <title>NoiseCanvas - Web Audio Demo</title>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: monospace;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 { color: #4ec9b0; }
    .section {
      background: #252526;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid #3e3e42;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: monospace;
      font-size: 14px;
    }
    button:hover { background: #1177bb; }
    button:disabled {
      background: #3e3e42;
      cursor: not-allowed;
    }
    button.active {
      background: #0a7a3d;
      border: 2px solid #4ec9b0;
    }
    #status {
      margin-top: 10px;
      padding: 10px;
      background: #1e1e1e;
      border-left: 3px solid #4ec9b0;
    }
    .keyboard {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <h1>ðŸŽµ NoiseCanvas Web Audio Demo</h1>

  <div class="section">
    <h2>Step 1: Initialize</h2>
    <button id="initBtn">Initialize AudioContext</button>
    <div id="status">Click "Initialize" to start</div>
  </div>

  <div class="section">
    <h2>Step 2: Select Sample Collection</h2>
    <div style="margin-bottom: 15px;">
      <button class="collection-btn" data-collection="st01" disabled>ST-01 (Synth)</button>
      <button class="collection-btn" data-collection="808" disabled>808 (Drums)</button>
      <button class="collection-btn" data-collection="openpath" disabled>OpenPath (Studio)</button>
    </div>
    <div id="loadStatus"></div>
  </div>

  <div class="section">
    <h2>Step 3: Connect MIDI (Optional)</h2>
    <button id="midiBtn" disabled>Connect MIDI Device</button>
    <div id="midiStatus">Connect a MIDI device to play with your keyboard</div>
  </div>

  <div class="section">
    <h2>Step 4: Play</h2>
    <h3>Piano Keyboard</h3>
    <div class="keyboard">
      <button class="note" data-note="C-3" disabled>C-3</button>
      <button class="note" data-note="D-3" disabled>D-3</button>
      <button class="note" data-note="E-3" disabled>E-3</button>
      <button class="note" data-note="F-3" disabled>F-3</button>
      <button class="note" data-note="G-3" disabled>G-3</button>
      <button class="note" data-note="A-3" disabled>A-3</button>
      <button class="note" data-note="B-3" disabled>B-3</button>
      <button class="note" data-note="C-4" disabled>C-4</button>
      <button class="note" data-note="D-4" disabled>D-4</button>
      <button class="note" data-note="E-4" disabled>E-4</button>
      <button class="note" data-note="F-4" disabled>F-4</button>
      <button class="note" data-note="G-4" disabled>G-4</button>
      <button class="note" data-note="A-4" disabled>A-4</button>
      <button class="note" data-note="B-4" disabled>B-4</button>
      <button class="note" data-note="C-5" disabled>C-5</button>
    </div>

    <h3>Drums</h3>
    <button class="drum" data-sample="kick" disabled>Kick</button>
    <button class="drum" data-sample="snare" disabled>Snare</button>
    <button class="drum" data-sample="hihat" disabled>Hi-Hat</button>

    <h3>Pattern</h3>
    <button id="patternBtn" disabled>Play Demo Pattern</button>
  </div>

  <script src="sampler-web.js"></script>
  <script type="module">
    import { connectMIDI, setupMIDIHandler } from './midi-web.js';

    let sampler = null;
    let midiAccess = null;
    let currentCollection = null;

    // Sample collection definitions
    const collections = {
      st01: {
        name: 'ST-01',
        piano: { url: '/data/samples/st-01/Steinway.wav', baseNote: 'C-2' },
        kick: { url: '/data/samples/st-01/BassDrum1.wav', baseNote: 'C-2' },
        snare: { url: '/data/samples/st-01/Snare1.wav', baseNote: 'C-2' },
        hihat: { url: '/data/samples/st-01/CloseHiHat.wav', baseNote: 'C-2' }
      },
      '808': {
        name: '808',
        piano: null, // No piano in 808 collection
        kick: { url: '/data/samples/808/kick.wav', baseNote: 'C-2' },
        snare: { url: '/data/samples/808/snare.wav', baseNote: 'C-2' },
        hihat: { url: '/data/samples/808/hihat-closed.wav', baseNote: 'C-2' },
        tom: { url: '/data/samples/808/tom.wav', baseNote: 'C-2' },
        cowbell: { url: '/data/samples/808/cowbell.wav', baseNote: 'C-2' },
        crash: { url: '/data/samples/808/crash.wav', baseNote: 'C-2' }
      },
      openpath: {
        name: 'OpenPath',
        piano: { url: '/data/samples/openpath/OpenPathMusic44V4/piano-studio-octave1.wav', baseNote: 'C-4' },
        kick: { url: '/data/samples/openpath/OpenPathMusic44V1/drum-bass-hi-1.wav', baseNote: 'C-2' },
        snare: { url: '/data/samples/openpath/OpenPathMusic44V1/drum-snare-tap.wav', baseNote: 'C-2' },
        hihat: { url: '/data/samples/openpath/OpenPathMusic44V1/cymbal-hihat-stick.wav', baseNote: 'C-2' },
        bell: { url: '/data/samples/openpath/OpenPathMusic44V1/bell-octave1.wav', baseNote: 'C-4' }
      }
    };

    // Initialize AudioContext
    document.getElementById('initBtn').addEventListener('click', async () => {
      sampler = new WebAudioSampler();
      await sampler.resume();

      document.getElementById('status').textContent = 'âœ“ AudioContext initialized';
      document.querySelectorAll('.collection-btn').forEach(btn => btn.disabled = false);
      document.getElementById('initBtn').disabled = true;
    });

    // Load sample collection
    async function loadCollection(collectionId) {
      const loadStatus = document.getElementById('loadStatus');
      const collection = collections[collectionId];

      loadStatus.textContent = `Loading ${collection.name} samples...`;

      try {
        // Clear previous samples
        sampler.samples.clear();

        // Load all samples in the collection
        const loadPromises = [];
        const loadedSamples = [];

        for (const [sampleName, sampleInfo] of Object.entries(collection)) {
          if (sampleName === 'name' || !sampleInfo) continue;

          loadPromises.push(
            sampler.loadSample(sampleName, sampleInfo.url, { baseNote: sampleInfo.baseNote })
              .then(() => loadedSamples.push(sampleName))
          );
        }

        await Promise.all(loadPromises);

        currentCollection = collectionId;
        loadStatus.textContent = `âœ“ ${collection.name} loaded: ${loadedSamples.join(', ')}`;

        // Update active button state
        document.querySelectorAll('.collection-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.collection === collectionId);
        });

        // Enable/disable piano buttons based on availability
        const hasPiano = collection.piano !== null;
        document.querySelectorAll('.note').forEach(btn => {
          btn.disabled = !hasPiano;
        });

        // Enable drum buttons
        document.querySelectorAll('.drum, #patternBtn').forEach(btn => {
          btn.disabled = false;
        });

        // Enable MIDI button if Web MIDI API is supported
        if (navigator.requestMIDIAccess) {
          document.getElementById('midiBtn').disabled = false;
          if (!hasPiano) {
            document.getElementById('midiStatus').textContent = 'MIDI will work for drums (channel 16)';
          } else {
            document.getElementById('midiStatus').textContent = 'Connect a MIDI device to play with your keyboard';
          }
        } else {
          document.getElementById('midiStatus').textContent = 'âœ— Web MIDI API not supported in this browser';
        }
      } catch (err) {
        loadStatus.textContent = `âœ— Error loading ${collection.name}: ${err.message}`;
        console.error('Sample loading error:', err);
      }
    }

    // Collection button handlers
    document.querySelectorAll('.collection-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        loadCollection(btn.dataset.collection);
      });
    });

    // Piano keyboard
    document.querySelectorAll('.note').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!sampler.hasSample('piano')) return;
        const note = btn.dataset.note;
        sampler.triggerNote('piano', note);
      });
    });

    // Drums
    document.querySelectorAll('.drum').forEach(btn => {
      btn.addEventListener('click', () => {
        const sampleName = btn.dataset.sample;
        if (!sampler.hasSample(sampleName)) {
          console.warn(`Sample ${sampleName} not found in current collection`);
          return;
        }
        const sample = sampler.getSample(sampleName);
        sampler.triggerNote(sampleName, sample.baseNote);
      });
    });

    // MIDI connection
    document.getElementById('midiBtn').addEventListener('click', async () => {
      const midiBtn = document.getElementById('midiBtn');
      const midiStatus = document.getElementById('midiStatus');

      try {
        midiAccess = await connectMIDI();

        const inputs = Array.from(midiAccess.inputs.values());

        // Display connected devices
        const deviceNames = inputs.map(input => input.name).join(', ');
        midiStatus.textContent = `âœ“ Connected to: ${deviceNames}`;
        midiBtn.disabled = true;

        // Set up MIDI message handlers for all inputs
        const hasPiano = sampler.hasSample('piano');
        const midiHandler = setupMIDIHandler(sampler, {
          melodicSample: hasPiano ? 'piano' : null
        });

        inputs.forEach(input => {
          input.onmidimessage = midiHandler;
        });

      } catch (err) {
        midiStatus.textContent = 'âœ— Error accessing MIDI: ' + err.message;
        console.error('MIDI Error:', err);
      }
    });

    // Pattern playback
    document.getElementById('patternBtn').addEventListener('click', () => {
      // Get base notes from loaded samples
      const kickNote = sampler.getSample('kick')?.baseNote || 'C-2';
      const snareNote = sampler.getSample('snare')?.baseNote || 'C-2';
      const hihatNote = sampler.getSample('hihat')?.baseNote || 'C-2';

      // Simple 8-beat pattern
      const pattern = [
        [{ sample: 'kick', note: kickNote }, { sample: 'hihat', note: hihatNote }],
        [{ sample: 'hihat', note: hihatNote }],
        [{ sample: 'snare', note: snareNote }, { sample: 'hihat', note: hihatNote }],
        [{ sample: 'hihat', note: hihatNote }],
        [{ sample: 'kick', note: kickNote }, { sample: 'hihat', note: hihatNote }],
        [{ sample: 'kick', note: kickNote }, { sample: 'hihat', note: hihatNote }],
        [{ sample: 'snare', note: snareNote }, { sample: 'hihat', note: hihatNote }],
        [{ sample: 'hihat', note: hihatNote }]
      ];

      sampler.playPattern(pattern, { bpm: 120, repeat: 2 });
    });
  </script>
</body>
</html>
